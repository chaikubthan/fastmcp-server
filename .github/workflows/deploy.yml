name: Deploy FastMCP to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # --- 1) Checkout ---
    - name: Checkout source code
      uses: actions/checkout@v4

    # --- 2) Setup Python ---
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # --- 3) Install dependencies ---
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt

    # --- 4) Run unit tests (Stop deploy if fail) ---
    - name: Run MCP Unit Tests
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        MCP_PORT: ${{ secrets.MCP_PORT }}
      run: |
        pytest -rP

    # --- 5) Setup SSH Key ---
    - name: Setup SSH Key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ssh_key
        chmod 600 ssh_key
    
    # --- 6) Check EC2 Health ---
    - name: Check EC2 Health
      run: |
        ssh -i ssh_key -o StrictHostKeyChecking=no \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'EC2 OK'"

    # --- 7) Level 2: Check Docker Daemon on EC2 ---
    - name: Check Docker is running
      run: |
        ssh -i ssh_key -o StrictHostKeyChecking=no \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "\
          systemctl is-active --quiet docker || (echo '❌ Docker is NOT running' && exit 1)
        "
        echo "✔ Docker daemon is running"

    # --- 8) Upload files to EC2 ---
    - name: Upload files to EC2
      run: |
        rsync -avz --exclude '.git' --exclude '.github' --exclude '__pycache__' \
          -e "ssh -i ssh_key -o StrictHostKeyChecking=no" \
          ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/fastmcp/

    # --- 9) Restart MCP server remotely ---
    - name: Restart FastMCP
      run: |
        ssh -i ssh_key -o StrictHostKeyChecking=no \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ~/fastmcp
          
          echo "Stopping old containers..."
          docker compose down || docker-compose down || true

          echo "Rebuilding & starting new containers..."
          docker compose up -d --build || docker-compose up -d --build

          echo "Deployment complete!"
        EOF

    # --- 10) Level 3: POST-DEPLOY PORT CHECK ---
    - name: Check MCP port after deployment
      run: |
        echo "Checking MCP port..."
        nc -z -w5 ${{ secrets.EC2_HOST }} ${{ secrets.MCP_PORT }} \
          || (echo '❌ MCP port NOT open after deployment' && exit 1)
        echo "✔ MCP port is open — deployment successful!"


