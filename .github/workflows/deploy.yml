name: Deploy FastMCP to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # --- 1) Checkout ---
    - name: Checkout source code
      uses: actions/checkout@v4

    # --- 2) Setup Python ---
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # --- 3) Install dependencies ---
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
    # --- 4) Start MCP server locally ---
    - name: Start MCP Server locally
      run: |
        nohup python main.py > mcp_server.log 2>&1 &
        sleep 4
    
    # --- 5) Run unit tests against local MCP server ---
    - name: Run Unit Tests (Local MCP)
      env:
        MCP_URL: "http://localhost:3000/mcp"
      run: |
        pytest tests/local_test.py -rP
        
    # --- 6) Setup SSH Key ---
    - name: Setup SSH Key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > ssh_key
        chmod 600 ssh_key
    
    # --- 7) Check EC2 Health ---
    - name: Check EC2 Health
      run: |
        ssh -i ssh_key -o StrictHostKeyChecking=no \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'EC2 OK'"

    # --- 8) Check Docker Daemon on EC2 ---
    - name: Check Docker is running
      run: |
        ssh -i ssh_key -o StrictHostKeyChecking=no \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "\
          systemctl is-active --quiet docker || (echo '❌ Docker is NOT running' && exit 1)
        "
        echo "✔ Docker daemon is running"

    # --- 9) Upload files to EC2 ---
    - name: Upload files to EC2
      run: |
        rsync -avz --exclude '.git' --exclude '.github' --exclude '__pycache__' \
          -e "ssh -i ssh_key -o StrictHostKeyChecking=no" \
          ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/fastmcp/

    # --- 10) Restart MCP server remotely ---
    - name: Restart FastMCP
      run: |
        ssh -i ssh_key -o StrictHostKeyChecking=no \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd ~/fastmcp
          
          echo "Stopping old containers..."
          docker compose down || docker-compose down || true

          echo "Rebuilding & starting new containers..."
          docker compose up -d --build || docker-compose up -d --build

          echo "Deployment complete!"
        EOF

    # --- 11) Wait for EC2 MCP server to become ready ---
    - name: Wait for MCP Ready
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        MCP_PORT: ${{ secrets.MCP_PORT }}
      run: |
        echo "Waiting for MCP server to be ready..."
        for i in {1..10}; do
          if curl -s http://$EC2_HOST:$MCP_PORT/mcp > /dev/null; then
            echo "✔ MCP is ready!"
            break
          fi
          echo "MCP not ready yet... retry $i/10"
          sleep 3
        done

        # If still not ready after retries, exit
        if ! curl -s http://$EC2_HOST:$MCP_PORT/mcp > /dev/null; then
          echo "❌ MCP did NOT become ready"
          exit 1
        fi

    # --- 12) Run post-deploy Integration Tests ---
    - name: Run MCP Unit Tests (EC2 Integration Test)
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        MCP_PORT: ${{ secrets.MCP_PORT }}
      run: |
        pytest tests/test_mcp_server.py  -rP

    - name: Upload MCP Log
      uses: actions/upload-artifact@v4
      with:
        name: mcp-log
        path: mcp_server.log        


